function getCookie(c_name) {
  if (document.cookie.length > 0) {
    let c_start = document.cookie.indexOf(c_name + "=");
    if (c_start != -1) {
      c_start = c_start + c_name.length + 1;
      c_end = document.cookie.indexOf(";", c_start);
      if (c_end == -1) c_end = document.cookie.length;
      return unescape(document.cookie.substring(c_start, c_end));
    }
  }
  return "";
}

function setCookie(name, value) {
  const Days = 1;
  const exp = new Date();
  exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
  document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString();
}

function getNextDate() {
  const today = new Date(); // 获取当前日期对象
  const year = today.getFullYear();  // 获取当前年份
  const month = today.getMonth() + 1;  // 获取当前月份 (0-11, 所以需要加 1)
  const day = today.getDate();  // 获取当前日期（1-31）
  // 格式化成 "年-月-日" 格式，月份和日期如果小于10补零
  const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;
  return formattedDate;
}

function getQueryParam(url, param) {
  const regex = new RegExp("[?&]" + param + "=([^&#]*)", "i");
  const match = url.match(regex);
  return match ? decodeURIComponent(match[1]) : null;
}

function calculateLoan(loanAmount, months, method) {
  const monthlyRate = 10.5 / 12 / 100;  // 月利率
  const dailyRate = 10.5 / 365 / 100;   // 日利率
  let totalRepayment = 0;  // 总还款
  let totalInterest = 0;   // 总利息
  const repayments = [];   // 每期还款信息
  const start = new Date(getNextDate());  // 转换开始日期为 Date 对象
  function formatDate(date) {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  }
  if (method === "等额本息") {
    // 等额本息的月还款金额计算公式
    const monthlyRepayment = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, months) / (Math.pow(1 + monthlyRate, months) - 1);
    for (let i = 1; i <= months; i++) {
      const interestForMonth = loanAmount * monthlyRate;  // 每期利息
      const principalForMonth = monthlyRepayment - interestForMonth;  // 每期本金
      loanAmount -= principalForMonth;  // 减少剩余本金
      totalRepayment += monthlyRepayment;  // 累加总还款
      totalInterest += interestForMonth;   // 累加总利息
      const repaymentDate = new Date(start);  // 复制开始日期
      repaymentDate.setMonth(start.getMonth() + i);  // 设置还款月份
      repayments.push({
        date: formatDate(repaymentDate),
        repayment: monthlyRepayment.toFixed(2),
        principal: principalForMonth.toFixed(2),
        interest: interestForMonth.toFixed(2),
        remainingPrincipal: loanAmount.toFixed(2)
      });
    }
  } else if (method === "等额本金") {
    // 等额本金，每期偿还相同本金
    const principalPerMonth = loanAmount / months;
    for (let i = 1; i <= months; i++) {
      const interestForMonth = loanAmount * monthlyRate;  // 每期利息
      const repaymentForMonth = principalPerMonth + interestForMonth;  // 每期还款
      loanAmount -= principalPerMonth;  // 减少剩余本金
      totalRepayment += repaymentForMonth;  // 累加总还款
      totalInterest += interestForMonth;   // 累加总利息
      const repaymentDate = new Date(start);  // 复制开始日期
      repaymentDate.setMonth(start.getMonth() + i);  // 设置还款月份
      repayments.push({
        date: formatDate(repaymentDate),
        repayment: repaymentForMonth.toFixed(2),
        principal: principalPerMonth.toFixed(2),
        interest: interestForMonth.toFixed(2),
        remainingPrincipal: loanAmount.toFixed(2)
      });
    }
  } else if (method === "随借随还") {
    // 随借随还方式：每月按天计算利息，但不进行实际还款，最后一次还款时一次性结清所有本金和利息
    let currentPrincipal = Number(loanAmount);
    let totalInterestForMonths = 0;
    for (let i = 1; i <= months - 1; i++) {
      // 每月计算利息，假设每个月按30天
      const interestForMonth = currentPrincipal * dailyRate * 30;  // 每月利息
      totalInterestForMonths += interestForMonth;  // 累加总利息
      const repaymentDate = new Date(start);  // 复制开始日期
      repaymentDate.setMonth(start.getMonth() + i);  // 设置还款月份
      repayments.push({
        date: formatDate(repaymentDate),
        repayment: interestForMonth.toFixed(2),  // 每期不进行实际还款
        principal: "0.00",  // 不偿还本金
        interest: interestForMonth.toFixed(2),  // 仅支付利息
        remainingPrincipal: currentPrincipal.toFixed(2)  // 保持剩余本金不变
      });
    }

    // 最后一期结清所有本金和利息
    const finalRepaymentDate = new Date(start);
    finalRepaymentDate.setMonth(start.getMonth() + months);  // 设置为最后一期还款日期
    const finalInterest = currentPrincipal * dailyRate * 30;  // 计算最后一期的利息
    const finalRepayment = currentPrincipal + finalInterest;   // 总还款为本金 + 利息
    totalRepayment += finalRepayment;  // 累加最后的总还款
    totalInterest += totalInterestForMonths + finalInterest;    // 累加最后的总利息
    repayments.push({
      date: formatDate(finalRepaymentDate),
      repayment: finalRepayment.toFixed(2),  // 最后期的总还款
      principal: currentPrincipal.toFixed(2),  // 最后一期的本金
      interest: finalInterest.toFixed(2),  // 最后一期的利息
      remainingPrincipal: "0.00"  // 最后一期结清所有剩余本金
    });

  } else {
    throw new Error("无效的还款方式");
  }

  return {
    totalRepayment: totalRepayment.toFixed(2),
    totalInterest: totalInterest.toFixed(2),
    repayments
  };
}


var timer = null;
function countdown() {
  var countTime = 60;
  timer = setInterval(() => {
    if (countTime <= 0) {
      clearInterval(timer);
      $('.code .sendbtn').text('重发验证码');
      $('.code .sendbtn').prop('disabled', false);
    } else {
      $('.code .sendbtn').text(`${countTime}s`);
      $('.code .sendbtn').prop('disabled', true);
      countTime--;
    }
  }, 1000);
}

class RequestManager {
  constructor() {
    this.requests = new Map(); // 用于存储正在进行的请求
    this.responses = new Map(); // 用于存储请求的结果
  }
  // 检查是否已经有相同的请求在进行中
  isRequestInProgress(url, options) {
    const key = JSON.stringify({ url, options });
    return this.requests.has(key);
  }
  // 获取请求的结果
  getResponse(url, options) {
    const key = JSON.stringify({ url, options });
    return this.responses.get(key);
  }
  // 添加请求到管理器中
  addRequest(url, options) {
    const key = JSON.stringify({ url, options });
    this.requests.set(key, true);
  }
  // 存储请求的结果
  storeResponse(url, options, response) {
    const key = JSON.stringify({ url, options });
    this.responses.set(key, response);
  }
  // 从管理器中移除已完成的请求
  removeRequest(url, options) {
    const key = JSON.stringify({ url, options });
    this.requests.delete(key);
    this.responses.delete(key); // 同时移除存储的结果
  }
}

const requestManager = new RequestManager();

// 发起 fetch 请求之前检查是否已经有相同的请求在进行中
function fetchWithCheck(url, method, options) {

  // 检查是否有重复的请求结果
  if (requestManager.getResponse(url, options)) {
    console.log('重复请求的结果已存在，直接返回结果。');
    return Promise.resolve(requestManager.getResponse(url, options));
  }

  // 检查是否已经有相同的请求在进行中
  if (requestManager.isRequestInProgress(url, options)) {
    console.log('相同请求已经在进行中，等待结果。');
    return new Promise((resolve) => {
      const interval = setInterval(() => {
        const response = requestManager.getResponse(url, options);
        if (response) {
          clearInterval(interval);
          resolve(response);
        }
      }, 100); // 每100毫秒检查一次结果
    });
  }

  // 如果没有相同的请求在进行中，则添加新请求到管理器中
  requestManager.addRequest(url, options);
  const params = {
    method: method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(options)
  };
  const domain = '/api';

  return fetch(domain + url, params)
    .then(response => response.json())
    .then(response => {
      // 存储请求的结果
      requestManager.storeResponse(url, options, response);
      // 请求完成后从管理器中移除该请求
      requestManager.removeRequest(url, options);
      return response;
    })
    .catch(error => {
      // 请求完成后从管理器中移除该请求
      requestManager.removeRequest(url, options);
      throw error;
    });
}

// 发送验证码
async function sendCode(mobile,channelSign) {
  clearInterval(timer);
  var res = await fetchWithCheck('/user/api/verify/request/h5sms','POST',{ phone:mobile,sign: channelSign });
  if (res.code == 200) {
      countdown();
  } else {
    $('#myDialog .dialogcont').text(res.msg);
    dialog.showModal();
  }
}

function newJump(token, channelSign, phone,) {
  let uri = `token=${token}&channelSign=${channelSign}`;
    window.location.replace("/tcwyh5/haluo?" + encodeURIComponent(uri))
//  //注册后是否下载
//  if (regDownload==1){
//   window.location.replace("/tcwyh5/tyr?" + encodeURIComponent(uri))
// }else {
//    // 是否跳转下载页
// if (params.falg == true) {
//    //h5Switch H5助贷开关 1开0关
// if (params.h5Switch == 1) {
//   // formSwitch 长短表单开关
//   if (params.formSwitch == 0) {
//     window.location.replace("/tcwyh5/?" + encodeURIComponent(uri))
//   } else if (params.formSwitch == 1) {
//     uri += ('&phone='+phone)
//     window.location.replace("/tcwyh5/haluo?" + encodeURIComponent(uri))
//   }
// } else if (params.h5Switch == 0) {
//   const href = params.formSwitch == 0 ? ("/tcwyh5/result?" + encodeURIComponent(uri)) : ("/tcwyh5/match?" + encodeURIComponent(uri));
//   window.location.replace(href)
// } 
// } else {
//   const href = params.formSwitch == 0 ? ("/tcwyh5/result?" + encodeURIComponent(uri)) : ("/tcwyh5/match?" + encodeURIComponent(uri));
//   window.location.replace(href)
// }
// }

}

async function getChanel(channelSign) {
  const res = await fetchWithCheck('/openClose/channelSwitch','POST',{ channelSign: channelSign });
  if(res.code == 200){
    channelInfo = res.data;
    if(res.data.backSwitch == 0){
      $('.navtop img').remove();
    }
    islogin(channelSign,channelInfo);
  }
}
function islogin(channelSign,channelInfo){
  const token = getCookie("token");
  const redToken = getCookie("redToken");
  const phone = getCookie("phone");
  const url = encodeURIComponent(`token=${token}&channelSign=${channelSign}&redToken=${redToken}&phone=${phone}`);
//  if(channelInfo.regDownload==1){
//   window.location.href = `/tcwyh5/tyr?${url}`;
//   }else 
  if(token){
    window.location.href = `/tcwyh5/?${url}`;
  }
}
// 登录
function loginAction(code,channelSign){
  // 判断验证码
  if(!/^\d{4}$/.test(code)){
    $('#myDialog .dialogcont').text('验证码格式不正确');
    dialog.showModal();
    return false;
  }
  var params = {
    phone: $('.phone input').val(),
    code: code,
    channelSign: channelSign,
    location: window.location.href,
  }
  const isIos =/(iphone|ipad|Mac OS|iPod|iOS)/i.test(navigator.userAgent);
  if(isIos){
    params.ios = 1;
  }
  fetchWithCheck('/web/account/signup/sms','POST',params).then(res => {
    if(res.code == 200){
      const data = res.data;
      setCookie('token',data.token);
      setCookie('phone',params.phone);
      sessionStorage.setItem('userId',data.userId);
      sessionStorage.setItem('phone',params.phone);
      // 跳转页面
       let uri = `token=${data.token}&channelSign=${channelSign}`;
        window.location.replace("/tcwyh5?" + encodeURIComponent(uri))
      newJump(data.token,channelSign,params.phone,);
    }else{
      // alert(res.msg);
      $('#myDialog .dialogcont').text(res.msg);
      dialog.showModal();
    }
  });
}

window.onpopstate = function (event) {
  if(cid == 'JW9Da8pfwl0=') return false;
  history.pushState(null, null, document.URL);
  const url = window.location.href;
  const regex = /\/([^\/]+)\.html/;
  const match = regex.exec(url);
  if (match) {
    fetchWithCheck('/openClose/h5LandingUrl','POST',{"channelCode":match[1]}).then(res=>{
      if(res.code == 200){
          $('.wldialog .ico').attr('src',res.data.icon);
          $('.wldialog .desc .name').text(res.data.name);
          $('.wldialog .btn').attr('tid',res.data.id);
          $('.wldialog .btn').attr('cid',match[1]);
          document.querySelector('.wlmask').classList.remove('hidden');
      }
    })
  }
};

function debounce(func, delay = 500) {
  let dtimer;
  return function (...args) {
    // 清除之前的定时器
    clearTimeout(dtimer);
    // 设置新的定时器
    dtimer = setTimeout(() => {
      func(...args);
    }, delay);
  };
}
function numberToChinese(num) {
	const chineseNumerals = ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九"];
	const units = ["", "十", "百", "千"];
	let result = "";
	
	if (num < 10) {
			return chineseNumerals[num];
	}

	let unitPos = 0;
	let str = num.toString();
	let zeroFlag = false; // 用于处理连续的零

	for (let i = str.length - 1; i >= 0; i--) {
		let digit = parseInt(str.charAt(i), 10);
		if (digit === 0) {
			zeroFlag = true;
		} else {
			if (zeroFlag) {
				result = chineseNumerals[0] + result;
				zeroFlag = false;
			}
			result = chineseNumerals[digit] + units[unitPos] + result;
		}
		unitPos++;
	}

	if (result.startsWith("一十")) {
		result = result.substring(1);
	}

	return result;
}
// 处理还款计划
function handlePlan() {
  var money = $.trim($('.num input').val()).replace(',', '');
  var months = $('#selectMonth').text().replace(/个月/, '');
  var ways = $('#payways').text();
  const result = calculateLoan(money, months, ways);
  const str = result.repayments[0].date.split("-");
  $('#plan').html('首期'+str[1]+'月'+str[2]+'日应还<span>'+result.repayments[0].repayment+'</span>元')
  $('.planmask .tit span').text(ways);
  $('.planmask .rebox .sum').text(`借满${months}期，总利息¥ ${result.totalInterest}元`);
  var html = '';
  result.repayments.map((item,i)=>{
    html += '<div class="part"><div class="left"><div class="index">第'+numberToChinese(i+1)+'期</div><div class="date">'+item.date+'</div></div><div class="right"><div class="pay">¥ '+item.repayment+'元</div><div class="detail">含本金'+item.principal+'元，利息'+item.interest+'元</div></div></div>'
  })
  $(".scrolldiv").html(html);
}

$(function () {
  var channelSign = getCookie("cid") || cid;
  console.log(channelSign,'channelSign');
  
  getChanel(channelSign);

  // 关闭弹框
  dialog.addEventListener("click", function (e) {
    if (e.target.nodeName.toLowerCase() == "dialog") {
      dialog.close();
    }
  });
  
  var query = getQueryParam(window.location.href,'p');
  if(query){
    $('.phone input').val(query);
  }

  var pickerExtend1 = new PickerExtend({
    trigger: '#selectAction',
    title: '',
    wheels: [{ data: ['日常消费', '购买家具或家电', '装修', '婚庆', '教育培训', '健康医疗', '进货'] }],
    position: [0],
    callback: function (index, data) { }
  });
  var pickerExtend2 = new PickerExtend({
    trigger: '#selectMonth',
    title: '',
    wheels: [{ data: ['3个月', '6个月', '12个月', '36个月'] }],
    position: [2],
    callback: function (index, data) {
      handlePlan();
    }
  });
  var pickerExtend3 = new PickerExtend({
    trigger: '#payways',
    title: '',
    wheels: [{ data: ['随借随还', '等额本息', '等额本金'] }],
    position: [0],
    callback: function (index, data) {
      handlePlan();
    }
  });

  $('.money .num input').on('input', debounce(function () {
    var money = $('.money .num input').val().replace(/\D/g, '');
    if (money > 200000) {
      money = '200000';
    }
    $('.money .num input').val(money.replace(/\B(?=(\d{3})+(?!\d))/g, ','));
    handlePlan();
  }, 500));
  $('.money .all').click(function () {
    $('.money .num input').val('20,0000');
    handlePlan();
  });

  handlePlan();
  $('#plan').click(function () {
    $('.planmask').removeClass('hide');
  });

  $('.planmask').click(function (e) {
    if (!$(e.target).closest(".repay").length) {
      $('.planmask').addClass('hide');
    }
  });

  // 限制输入手机号
  $('.phone input').on('input', function () {
    var mobile = $(this).val().replace(/\D/g, '');
    $(this).val(mobile);
    if (mobile.length > 11) {
      $(this).val(mobile.slice(0, 11));
    } else if (mobile.length == 11) {
      if (!/^1[3456789]\d{9}$/.test(mobile)) {
        $('#myDialog .dialogcont').text('手机号不正确');
        dialog.showModal();
        return false;
      }
    }
  });

  // 立即申请
  $('.card .btn').click(async function () {
    // 判断手机号是否正确
    var mobile = $('.phone input').val();
    if (!/^1[3456789]\d{9}$/.test(mobile)) {
      // alert('手机号不正确');
      $('#myDialog .dialogcont').text('手机号不正确');
      dialog.showModal();
      return false;
    }
    // 判断是否同意协议
    if (!$('.xybox input').is(':checked')) {
      // 弹出协议
      $('.agreemask').removeClass('hide');
      document.body.style.overflowY = 'hidden';
    } else {
      // 发送验证码
      // var result = await sendCode(mobile,channelSign);
      // if(!result){
      //   $('.sendmask .phone span').text(mobile.replace(/(\d{3})\d{4}(\d{4})/, '\$1****\$2'));
      //   $('.sendmask').removeClass('hide');
      //   document.body.style.overflowY = 'hidden';
      // }else{
      //   // 免登录
      //   loginAction('',channelSign,false);
      // }
       $('.sendmask .phone span').text(mobile.replace(/(\d{3})\d{4}(\d{4})/, '\$1****\$2'));
        $('.sendmask').removeClass('hide');
        document.body.style.overflowY = 'hidden';
      // loginAction('',channelSign,false);
      
    }
  });

  $('.agreemask .cancel').click(function () {
    $('.agreemask').addClass('hide');
    document.body.style.overflowY = 'scroll';
  });
  $('.agreemask .agree').click(async function () {
    // 关闭弹框
    $('.agreemask').addClass('hide');
    document.body.style.overflowY = 'scroll';
    $('.xybox input').prop('checked', true);
    var mobile = $('.phone input').val();
    // // 判断是否免登 发送验证码
    // var result1 = await sendCode(mobile,channelSign);
    // if(!result1){
    //   // 打开验证码
    //   sendCode(mobile);
    //   $('.sendmask .phone span').text(mobile.replace(/(\d{3})\d{4}(\d{4})/, '\$1****\$2'));
    //   $('.sendmask').removeClass('hide');
    //   document.body.style.overflowY = 'hidden';
    // }else{
    //   // 免登录
    //   loginAction('',channelSign,false);
    // }
      loginAction('',channelSign,false);

  });
  // 重新发送验证码
  $('.sendmask .sendbtn').click(function () {
    if (!$(this).prop('disabled')) {
      sendCode($('.phone input').val(),channelSign);
    }
  });
  // 验证码限制
  $('.sendmask .code input').on('input', function () {
    var code = $(this).val().replace(/\D/g, '');
    $(this).val(code);
    if (code.length > 4) {
      $(this).val(code.slice(0, 4));
    } else if (code.length == 4) {
      loginAction(code,channelSign,true);
    }
  });



  // 同意协议
  $('.comfirm .btn button,.comfirm .cocls').click(function () {
    var toggelBtn = $(this).attr('t');
    if (toggelBtn == 1) {
      $('.xybox #agree').prop('checked', true);
      // 发送验证码
      sendCode($('.phone input').val());
      $('.agreemask').addClass('hidden');
      $('.sendmask').removeClass('hidden');
      document.body.style.overflowY = 'hidden';
    } else {
      $('.agreemask').addClass('hidden');
      document.body.style.overflowY = 'scroll';
    }
  });
  // 提交登录
  $('.sendmask .comfirm').click(function () {
    // 获取验证码
    var code = $('.sendmask .code input').val();
    loginAction(code,channelSign,true);
  });


  // 查看协议
  $('.agreemask .desc span').click(function () {
    var iframeurl = `https://${window.location.hostname}/agreement/ysxy.html?title=0`;
    if ($(this).attr('t') == '1') {
      $('.iframe .txt').text('注册协议');
        iframeurl = `https://${window.location.hostname}/agreement/dlxy.html?title=0`;
    } else {
      $('.iframe .txt').text('隐私协议');
    }
    $('.iframe iframe').attr('src', iframeurl);
    $('.xymask').removeClass('hide');
    document.body.style.overflowY = 'hidden';
  })

  $('.wlmask .wldialog .close,.wlmask .wldialog .btn').click(function () {
    $('.wlmask').addClass('hide');
    document.body.style.overflowY = 'scroll';
  });
  $('.wlmask .wldialog .card').click(function () {
    var tid = $('.wlmask .wldialog .btn').attr('tid');
    var cid = $('.wlmask .wldialog .btn').attr('cid');
    fetchWithCheck('/openClose/h5Landing/apply', 'POST', { "appId": tid, "channelCode": cid }).then(ress => {
      if (ress.code == 200) {
        window.location.href = ress.data;
      }
    }).finally(() => {
      document.querySelector('.wlmask').classList.remove('hide');
      document.body.style.overflowY = 'scroll';
    })
  })

  // 注册隐私协议
  $('.xybox span').click(function () {
    var iframeurl = $(this).attr('t') == 1 ? `https://${window.location.hostname}/agreement/dlxy.html?title=0` : `https://${window.location.hostname}/agreement/ysxy.html?title=0`;
    $('.iframe iframe').attr('src', iframeurl);
    $('.iframe .txt').text($(this).attr('t') == 1 ? '注册协议' : '隐私协议');
    setTimeout(function () {
      $('.xymask').removeClass('hide');
      document.body.style.overflowY = 'hidden';
    }, 100);
  });

  $('.xymask').click(function (event) {
    if (!event.target.closest('.iframe') || event.target.classList.contains('close')) {
      $('.xymask').addClass('hide');
      document.body.style.overflowY = 'scroll';
    }
  });


})
